<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <style type="text/css">
        body,
        html,
        #allmap {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
        }
    </style>
    <script
        type="text/javascript"
        src="https://api.map.baidu.com/api?v=2.0&ak=C6272e532ab6f729b502ddc67219b8f9"
    ></script>
    <title>单个标注点沿直线的轨迹运动</title>
</head>
<body>
<div id="allmap"></div>
</body>
</html>
<script type="text/javascript">
	// hexyun内置百度地图通用api
	/**
	 * @param opts {Object}
     *
     * ```js
     * new HexMap({
         map: new BMap.Map("allmap"),
         start: start,
         end: end,
         icon: {
            start: {url: 'img/avatar.png', size: [20, 20]},
            end: {url: 'img/logo.png', size: [20, 20]}
        }
     })```
     *
	 */
	function HexMap(opts) {
		this.map = opts.map;
		this.start = this.point(opts.start);
		this.end = this.point(opts.end);
		this.map.centerAndZoom(this.start, 15);
		this.driver = new BMap.DrivingRoute(this.map, {
			renderOptions: {map: this.map, autoViewport: true}
		});
		this._startIcon = null;
		this._endIcon = null;
		this._label = null;
		this.labelStyle = opts.labelStyle || {
			color: "#111",
			fontSize: "12px",
			height: "20px",
			lineHeight: "20px",
			fontFamily: "微软雅黑",
			border: "none"
		}

		var icon = opts.icon || {}

		if(icon.start && icon.start.url) {
			this._startIcon = new BMap.Icon(icon.start.url, new BMap.Size(icon.start.size[0], icon.start.size[1]))
		}
		if(icon.end && icon.end.url) {
			this._endIcon = new BMap.Icon(icon.end.url, new BMap.Size(icon.end.size[0], icon.end.size[1]))
		}
	}

	HexMap.point = function(coord) {
		return new BMap.Point(coord[0], coord[1])
	}
	HexMap.prototype.point = function(coord) {
		return HexMap.point(coord)
	}

	/**
	 *
	 * @param start {Array} 起始经纬度
	 * @param end {Array} 终点经纬度
	 */
	HexMap.prototype.drive = function(start, end) {
		var self = this
		start = start ? this.point(start) : this.start
		end = end ? this.point(end) : this.end

		this.driver.search(start, end); //显示一条公交线路
		this.driver.setSearchCompleteCallback(function() {
			self.labelDistance(start, end);
		});
		if(this._startIcon && this._endIcon)
			this.driver.setMarkersSetCallback(function(result) {
				result[0].marker.setIcon(self._startIcon);
				result[1].marker.setIcon(self._endIcon);
			});
	};
	HexMap.prototype.labelDistance = function(start, end) {
		var d = (this.map.getDistance(start, end) / 1000).toFixed(2);
		var content = "距离目标" + d + "km";

		if(!this.label) {
			var opts = {
				position: start, // 指定文本标注所在的地理位置
				offset: new BMap.Size(-40, -40) //设置文本偏移量
			};
			this.label = new BMap.Label(content, opts);
			this.label.setStyle(this.labelStyle);
			this.map.addOverlay(this.label)
		} else {
			this.label.setContent(content);
			this.label.setPosition(start);
		}
	}
	/**
     * @description 修复GPS坐标到百度坐标
	 * @param coords {Array}
	 */
	HexMap.fixCoords = function(coords) {
		var convertor = new BMap.Convertor();
		var pointArr = [];
		pointArr.push(new BMap.Point(coords[0],coords[1]));
		return new Promise(function(resolve, reject){
			convertor.translate(pointArr, 1, 5, function(data){
				if(data.status === 0) {
					resolve([data.points[0].lng, data.points[0].lat])
				} else {
					reject({
                        code: -101,
                        message: '百度地图坐标转换失败'
                    })
                }
            })
        })
    }
	HexMap.locate = function() {
		return new Promise(function(resolve, reject) {
			if(window.navigator.geolocation) {
				window.navigator.geolocation.getCurrentPosition(function(data) {
					return resolve(HexMap.fixCoords([data.coords.longitude, data.coords.latitude]))
				}, reject);
			} else {
				reject(new Error({
					code: -10000,
					message: '您的浏览器不支持地理定位'
				}))
			}
		})
	}
	var hexMap, end = [116.380967, 39.913285]

	function run() {
		HexMap.locate().then(function(data) {
			var start = data
			if(!hexMap) {
				hexMap = new HexMap({
					map: new BMap.Map("allmap"),
					start: start,
					end: end,
					icon: {
						start: {url: 'img/avatar.png', size: [20, 20]},
						end: {url: 'img/logo.png', size: [20, 20]}
					}
				})
				hexMap.drive()
			} else {
				hexMap.drive(start, null)
			}
			console.log(data)
		}).catch(function(e) {
			if(e.message) alert(e.message)
		})

	}

	var start = [116.424374, 39.914668];


	var count = 0,
		timer;
	timer = setInterval(function() {
		run()
		if(count++ > 10) {
			clearInterval(timer);
		}
	}, 1000);
</script>
